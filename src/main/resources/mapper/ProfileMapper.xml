<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.swyp3.babpool.domain.profile.dao.ProfileRepository">

    <resultMap id="profilePagingDto" type="com.swyp3.babpool.domain.profile.application.response.ProfilePagingDto">
        <result property="profileId" column="profile_id"/>
        <result property="userId" column="user_id"/>
        <result property="profileImageUrl" column="profile_image_url"/>
        <result property="profileIntro" column="profile_intro"/>
        <result property="profileContents" column="profile_contents"/>
        <result property="profileModifyDate" column="profile_modify_date"/>
        <result property="keywordNamesConcat" column="keyword_info"/>
        <result property="userGrade" column="user_grade"/>
        <result property="userNickname" column="user_nick_name"/>
    </resultMap>

    <select id="findAllByPageable"
            parameterType="com.swyp3.babpool.global.common.request.PagingRequestList"
            resultMap="profilePagingDto">
        SELECT profile.profile_id, profile.user_id, profile.profile_image_url, profile.profile_intro, profile.profile_contents,
               profile.profile_modify_date,
            GROUP_CONCAT(k.keyword_name) AS keyword_info, account.user_grade, account.user_nick_name
        FROM t_profile as profile
            inner JOIN t_user_account account ON profile.user_id = account.user_id
            inner JOIN t_m_user_keyword muk ON profile.user_id = muk.user_id
            inner JOIN t_keyword k ON muk.keyword_id = k.keyword_id
        <where>
            <if test="condition.search != null and !condition.search.equals('')">
                (
                profile.profile_intro LIKE CONCAT('%', #{condition.search}, '%')
                OR profile.profile_contents LIKE CONCAT('%', #{condition.search}, '%')
                OR account.user_nick_name LIKE CONCAT('%', #{condition.search}, '%')
                )
            </if>
            <if test="condition.keywords != null and !condition.keywords.isEmpty()">
                <foreach collection="condition.keywords" item="keyword" open="AND muk.keyword_id IN (" close=")" separator=",">
                    #{keyword}
                </foreach>
            </if>
            <if test="condition.userGrades != null and !condition.userGrades.isEmpty()">
                <foreach collection="condition.userGrades" item="userGrade" open="AND account.user_grade IN (" close=")" separator=",">
                    #{userGrade}
                </foreach>
            </if>
            AND profile.profile_active_flag = 1
        </where>
        GROUP BY profile.profile_id
        <if test="pageable.sort != null and !pageable.sort.isEmpty()">
            ORDER BY
            <foreach collection="pageable.sort" item="order" separator=",">
                ${order.property} ${order.direction}
            </foreach>
        </if>
        LIMIT #{pageable.pageSize} OFFSET #{pageable.offset}
    </select>

    <select id="countByPageable" parameterType="com.swyp3.babpool.domain.profile.api.request.ProfilePagingConditions"
            resultType="java.lang.Integer">
        SELECT COUNT(DISTINCT profile.profile_id) FROM t_profile as profile
            inner JOIN t_user_account as account
                ON profile.user_id = account.user_id
            inner JOIN t_m_user_keyword muk
                ON profile.user_id = muk.user_id
        <where>
            <if test="search != null and !search.equals('')">
                (
                profile.profile_intro LIKE CONCAT('%', #{search}, '%')
                OR profile.profile_contents LIKE CONCAT('%', #{search}, '%')
                OR account.user_nick_name LIKE CONCAT('%', #{search}, '%')
                )
            </if>
            <if test="keywords != null and !keywords.isEmpty()">
                <foreach collection="keywords" item="keyword" open="AND muk.keyword_id IN (" close=")" separator=",">
                    #{keyword}
                </foreach>
            </if>
            <if test="userGrades != null and !userGrades.isEmpty()">
                <foreach collection="userGrades" item="userGrade" open="AND account.user_grade IN (" close=")" separator=",">
                    #{userGrade}
                </foreach>
            </if>
            AND profile.profile_active_flag = 1
        </where>
    </select>

    <insert id="saveProfile" parameterType="com.swyp3.babpool.domain.profile.domain.Profile">
        INSERT INTO t_profile (user_id, profile_image_url,profile_active_flag )
        VALUES (#{userId}, #{profileImageUrl},#{profileActiveFlag} )
    </insert>

    <select id="findById" resultType="com.swyp3.babpool.domain.profile.domain.Profile">
        select *
        from t_profile
        where profile_id = #{profileId}
    </select>

    <select id="getKeywords" resultType="com.swyp3.babpool.domain.profile.application.response.KeywordsResponse">
        SELECT JSON_OBJECTAGG(subject_name,keyword_name_list) AS keywords
        FROM (
                 SELECT
                     s.subject_name,
                     JSON_ARRAYAGG(k.keyword_name) AS keyword_name_list
                 FROM
                     t_profile p
                         INNER JOIN t_user_account u on u.user_id = p.user_id
                         INNER JOIN t_m_user_keyword muk ON u.user_id = muk.user_id
                         INNER JOIN t_keyword k ON muk.keyword_id = k.keyword_id
                         INNER JOIN t_subject s ON k.subject_id = s.subject_id
                 WHERE p.profile_id = #{profileId}
                 GROUP BY
                     s.subject_name
             )tb_json_arrayagg
    </select>

    <select id="getProfileDetail" resultType="com.swyp3.babpool.domain.profile.application.response.ProfileDetailDaoDto">
        SELECT
            p.profile_id AS profileId,
            ua.user_nick_name AS name,
            p.profile_image_url AS profileImg,
            ua.user_grade AS grade,
            p.profile_intro AS intro,
            p.profile_contents AS contents
        FROM
            t_profile p
                INNER JOIN
            t_user_account ua ON p.user_id = ua.user_id
        WHERE
            p.profile_id = #{profileId}
    </select>

    <update id="updateProfileImageUrl" parameterType="com.swyp3.babpool.domain.profile.domain.Profile">
        UPDATE t_profile SET profile_image_url = #{profileImageUrl} where user_id = #{userId}
    </update>

</mapper>